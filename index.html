<head>
    <title>foobar</title>
    <script src="https://cdn.jsdelivr.net/g/jquery@3.2.1,markdown-it@8.3.1,highlight.js@9.10.0"></script>
</head>

<body>
    <div id="sarea" contenteditable="true">sarea bfegin</div>
    <div id="tarea">rarea begin</div>
    <div id="rarea">rarea begin</div>
    <script>
        function replaceAll(str, match, rep) {
            tmparr = str.split(match);
            result = "";
            i = 0;
            for (; i < tmparr.length - 1; i++) {
                result += tmparr[i] + rep;
            }
            result += tmparr[i];
            return result;
        }

        function HTML2raw(source) {
            source = replaceAll(source, "<div></div>", "\n");
            //source = replaceAll(source, "</", "</");
            source = replaceAll(source, "</div>", "");
            source = replaceAll(source, "<div>", "\n")
            source = replaceAll(source, "<br>", "\n");
            source = replaceAll(source, "&gt;", ">");
            source = replaceAll(source, "&nbsp;", " ");
            return source;
        }
        ///////////////////////////////////////////////
        //var hljs = require('highlight.js') // https://highlightjs.org/
        // to do http://liuhao.im/english/2015/11/10/the-sync-scroll-of-markdown-editor-in-javascript.html
        var defaults = {
            html: false, // Enable HTML tags in source
            xhtmlOut: false, // Use '/' to close single tags (<br />)
            breaks: false, // Convert '\n' in paragraphs into <br>
            langPrefix: 'language-', // CSS language prefix for fenced blocks
            linkify: true, // autoconvert URL-like texts to links
            typographer: true, // Enable smartypants and other sweet transforms
            breaks: true,
            // options below are for demo only
            _highlight: true,
            _strict: false,
            _view: 'html', // html / src / debug
            highlight: function(str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(lang, str).value;
                    } catch (__) {}
                }

                return ''; // use external default escaping
            }
        };

        md = window.markdownit(defaults);
        ///////////////////////////////////////////////
        //$().onchange(function(){});
        $("#sarea").bind("DOMNodeInserted DOMNodeRemoved DOMCharacterDataModified", function() {
            source = $(this).html();
            source = HTML2raw(source);
            //console.log(source);
            $("#tarea").text(md.render(source));
            $("#rarea").html(md.render(source));
        });
        $(document).ready(function() {
            document.querySelector("#sarea").addEventListener("paste", function(e) {
                e.preventDefault();
                var text = e.clipboardData.getData("text/plain");
                var temp = document.createElement("div");
                temp.innerHTML = text;
                document.execCommand("insertHTML", false, replaceAll(temp.textContent, "\n", "<br>"));
            });
        });
    </script>
</body>